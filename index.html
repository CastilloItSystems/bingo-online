<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bingo Plus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Paleta de Colores Bingo Plus */
      :root {
        --color-bg: #f3e8ff; /* bg-purple-100 */
        --color-bg-alt: #ffffff; /* bg-white */
        --color-primary: #7e22ce; /* text-purple-700 */
        --color-primary-dark: #581c87; /* text-purple-900 */
        --color-secondary: #e11d48; /* text-pink-600 */
        --color-accent: #f59e0b; /* text-amber-500 */
        --color-text: #3730a3; /* text-indigo-800 */
        --color-admin-bg: #fdf4ff; /* bg-fuchsia-50 */
      }

      body {
        background-color: var(--color-bg);
        color: var(--color-text);
      }

      /* Estilo llamativo para BINGO PLUS */
      .logo-title {
        color: var(--color-accent);
        text-shadow: 2px 2px 4px var(--color-primary-dark);
      }

      .bingo-card-grid {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 0.5rem;
        max-width: 28rem;
        margin: auto;
      }
      .bingo-cell {
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        border-radius: 0.5rem;
        background-color: var(--color-bg-alt);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease-in-out;
        user-select: none;
        cursor: pointer; /* Indicar que es clickeable */
      }
      .bingo-cell:hover {
        transform: scale(1.05);
      }
      .bingo-cell.marked {
        background-color: var(--color-secondary);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(225, 29, 72, 0.4);
      }
      .bingo-cell.free {
        background-color: var(--color-accent);
        color: white;
        font-size: 1rem;
        line-height: 1.2;
      }
      /* Estilo llamativo para cabecera BINGO */
      .bingo-header-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.25rem;
        font-weight: 800;
        color: var(--color-primary);
        text-shadow: 1px 1px 2px var(--color-accent);
      }
      #current-number-display {
        width: 10rem;
        height: 10rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        background-color: var(--color-bg-alt);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        color: var(--color-primary-dark);
        font-size: 5rem;
        font-weight: 800;
        line-height: 1;
        transition: transform 0.2s ease;
      }
      #current-number-display.pop {
        transform: scale(1.1);
      }
      #win-message {
        animation: pulse-win 1s infinite;
      }
      @keyframes pulse-win {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.1);
        }
      }
      #modal {
        background-color: rgba(0, 0, 0, 0.5);
      }
      #active-cards-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        max-height: 200px;
        overflow-y: auto;
        background-color: #f3e8ff; /* bg-purple-100 */
        padding: 0.75rem;
        border-radius: 0.5rem;
      }
      .active-card-tag {
        background-color: #ede9fe; /* bg-violet-100 */
        color: #5b21b6; /* text-violet-800 */
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
      }
      .tote-board-number {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: white;
        color: var(--color-primary);
        font-weight: 600;
        font-size: 1rem;
        border-radius: 0.375rem;
        padding: 0.25rem 0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      /* Botones con nueva paleta */
      .btn-primary {
        background-color: var(--color-primary);
        color: white;
      }
      .btn-primary:hover {
        background-color: var(--color-primary-dark);
      }
      .btn-secondary {
        background-color: var(--color-secondary);
        color: white;
      }
      .btn-secondary:hover {
        background-color: #be123c; /* pink-700 */
      }
      .btn-accent {
        background-color: var(--color-accent);
        color: white;
      }
      .btn-accent:hover {
        background-color: #d97706; /* amber-600 */
      }
      .btn-gray {
        background-color: #9ca3af; /* bg-gray-400 */
        color: #1f2937; /* text-gray-800 */
      }
      .btn-gray:hover {
        background-color: #6b7280; /* bg-gray-500 */
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <!-- Modal para buscar cartón (oculto por defecto) -->
    <div
      id="modal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl text-center"
      >
        <h3 id="modal-title" class="text-2xl font-bold mb-4">
          Buscar mi Cartón
        </h3>
        <p id="modal-description" class="text-gray-600 mb-4">
          Introduce el ID de tu cartón (ej: 1, 45, etc.)
        </p>
        <input
          id="modal-input"
          type="number"
          class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-lg focus:border-purple-500 focus:ring-0"
          placeholder="Ej: 5"
        />
        <div id="modal-error" class="text-red-500 text-sm mt-2 h-4"></div>
        <div class="flex gap-4 mt-4">
          <button
            id="modal-cancel-button"
            class="flex-1 btn-gray font-bold py-3 px-6 rounded-lg transition-all duration-200"
          >
            Cancelar
          </button>
          <button
            id="modal-submit-button"
            class="flex-1 btn-primary font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200"
          >
            Buscar
          </button>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto">
      <h1
        id="main-title"
        class="logo-title text-4xl md:text-6xl font-extrabold text-center mb-4"
      >
        BINGO PLUS
      </h1>

      <!-- Info del Juego (ID y Premio) -->
      <div
        class="text-center mb-4 p-4 bg-white rounded-xl shadow-md max-w-lg mx-auto space-y-2"
      >
        <div class="flex justify-between items-center">
          <span class="text-lg font-semibold text-gray-700"
            >ID del Sorteo:</span
          >
          <span
            id="game-id-display"
            class="text-lg font-bold text-pink-600 bg-pink-50 px-3 py-1 rounded-full"
            >Cargando...</span
          >
        </div>
        <div class="flex justify-between items-center">
          <span class="text-lg font-semibold text-gray-700">Premio:</span>
          <span
            id="prize-display"
            class="text-lg font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full"
            >¡Mucha Suerte!</span
          >
        </div>
      </div>

      <!-- Botón para forzar modo Admin -->
      <div id="admin-toggle-button-wrapper" class="text-center mb-4">
        <button
          id="admin-toggle-button"
          class="btn-gray font-bold py-2 px-4 rounded-lg text-xs"
        >
          Activar Modo Admin
        </button>
      </div>

      <!-- Mensaje de BINGO (oculto por defecto) -->
      <div id="win-message" class="hidden text-center mb-6">
        <span
          id="win-message-text"
          class="text-6xl md:text-7xl font-extrabold text-amber-500"
          >¡B I N G O!</span
        >
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Columna Izquierda: Sorteo y Números Sorteados -->
        <div
          class="lg:col-span-1 bg-admin-bg p-6 rounded-2xl shadow-lg flex flex-col items-center gap-6 order-2 lg:order-1"
        >
          <!-- Número Sorteado Actual -->
          <div class="text-center">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">
              Número Sorteado
            </h2>
            <div id="current-number-display" class="mx-auto">-</div>
          </div>

          <!-- Panel de Administrador (oculto por defecto) -->
          <div id="admin-panel" class="hidden w-full space-y-4">
            <div class="flex flex-col sm:flex-row gap-4 w-full">
              <button
                id="draw-button"
                class="flex-1 btn-secondary font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 text-lg"
              >
                Sortear
              </button>
              <button
                id="reset-button"
                class="flex-1 btn-accent text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 text-lg"
              >
                Nuevo Juego
              </button>
            </div>

            <!-- Configuración de Juego (Premio y Modalidad) -->
            <div class="space-y-4 p-4 bg-white rounded-lg shadow-sm">
              <!-- Modalidad -->
              <div>
                <label
                  for="game-mode-select"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Modalidad de Juego:</label
                >
                <select
                  id="game-mode-select"
                  class="w-full border-2 border-gray-300 rounded-lg p-2 focus:border-purple-500 focus:ring-0"
                >
                  <option value="full_card">Cartón Lleno</option>
                  <option value="h_line">Línea Horizontal</option>
                  <option value="v_line">Línea Vertical</option>
                  <option value="corners">Cuatro Esquinas</option>
                </select>
              </div>
              <!-- Premio -->
              <div>
                <label
                  for="prize-input"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Premio Actual:</label
                >
                <div class="flex gap-2">
                  <input
                    id="prize-input"
                    type="text"
                    class="flex-1 w-full border-2 border-gray-300 rounded-lg p-2 focus:border-purple-500 focus:ring-0"
                    placeholder="Ej: 50 Bs"
                  />
                  <button
                    id="save-prize-button"
                    class="btn-primary font-semibold px-4 rounded-lg"
                  >
                    Guardar
                  </button>
                </div>
              </div>
            </div>

            <!-- Cartones Activos -->
            <div class="space-y-2">
              <h3 class="text-xl font-bold text-center text-gray-700">
                Cartones Activos
                <span
                  id="active-cards-count"
                  class="text-lg font-semibold text-purple-600"
                  >(0)</span
                >
              </h3>
              <div
                id="active-cards-list"
                class="border rounded-lg p-3 bg-white h-32 overflow-y-auto"
              >
                <!-- Los cartones activos se listarán aquí -->
              </div>
            </div>

            <p class="text-xs text-center text-gray-500">
              Estás en modo Administrador.
            </p>
          </div>

          <!-- Tablero de Números Sorteados (Tote Board) -->
          <div class="w-full">
            <h3 class="text-xl font-bold text-center text-gray-700 mb-4">
              Tablero de Sorteo
            </h3>
            <div
              class="grid grid-cols-5 gap-2 text-center bg-white p-2 rounded-lg shadow-inner"
            >
              <!-- Encabezados -->
              <div class="text-2xl font-extrabold text-purple-700">B</div>
              <div class="text-2xl font-extrabold text-purple-700">I</div>
              <div class="text-2xl font-extrabold text-purple-700">N</div>
              <div class="text-2xl font-extrabold text-purple-700">G</div>
              <div class="text-2xl font-extrabold text-purple-700">O</div>

              <!-- Contenedores de Números -->
              <div
                id="called-B"
                class="space-y-1 h-40 overflow-y-auto p-1 border border-gray-200 rounded-md"
              ></div>
              <div
                id="called-I"
                class="space-y-1 h-40 overflow-y-auto p-1 border border-gray-200 rounded-md"
              ></div>
              <div
                id="called-N"
                class="space-y-1 h-40 overflow-y-auto p-1 border border-gray-200 rounded-md"
              ></div>
              <div
                id="called-G"
                class="space-y-1 h-40 overflow-y-auto p-1 border border-gray-200 rounded-md"
              ></div>
              <div
                id="called-O"
                class="space-y-1 h-40 overflow-y-auto p-1 border border-gray-200 rounded-md"
              ></div>
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Cartones de Bingo -->
        <div
          class="lg:col-span-2 bg-purple-200 p-6 rounded-2xl shadow-lg order-1 lg:order-2"
        >
          <div class="max-w-md mx-auto">
            <!-- Panel de Jugador -->
            <div id="player-panel" class="mb-4 space-y-4 text-center">
              <button
                id="load-card-button"
                class="w-full btn-primary font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-200 text-lg"
              >
                Buscar mi Cartón
              </button>
              <button
                id="bingo-button"
                class="w-full btn-secondary font-bold py-4 px-6 rounded-lg shadow-lg transition-all duration-200 text-2xl animate-pulse"
              >
                ¡BINGO!
              </button>
            </div>

            <!-- Encabezado BINGO -->
            <div class="grid grid-cols-5 gap-2 mb-2">
              <div class="bingo-header-cell">B</div>
              <div class="bingo-header-cell">I</div>
              <div class="bingo-header-cell">N</div>
              <div class="bingo-header-cell">G</div>
              <div class="bingo-header-cell">O</div>
            </div>

            <!-- Área de Cartones de Bingo -->
            <div id="cards-area" class="space-y-6">
              <!-- Los cartones de bingo se generarán aquí con JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Importa las funciones que necesitas
      import {
        initializeApp,
        setLogLevel,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        onSnapshot,
        collection,
        writeBatch,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- CONTRASEÑA DE ADMIN ---
      // ¡Cámbiala aquí si lo deseas!
      const ADMIN_PASSWORD = "Clara2025";

      // Pega aquí la configuración de TU proyecto de Firebase
      // O usa la variable __firebase_config para probar en el 'Preview'
      const firebaseConfig = {
        apiKey: "AIzaSyAsfyZK5Gv7XkJYfh0GlJHRfMFBWzNQjmM",
        authDomain: "bingoclaravirginia.firebaseapp.com",
        projectId: "bingoclaravirginia",
        storageBucket: "bingoclaravirginia.firebasestorage.app",
        messagingSenderId: "290520708699",
        appId: "1:290520708699:web:a37d42aad57ea63228717e",
        measurementId: "G-YB1SG1JH6H",
      };

      const appId = typeof __app_id !== "undefined" ? __app_id : "bingo-plus";

      // Inicializa Firebase
      let app, auth, db;
      let userId = null;
      let isAdmin = false;

      // Estado del juego
      let currentGameId = null;
      let currentGameMode = "full_card"; // Valor por defecto
      let localLoadedCards = new Map();
      let calledNumbers = new Set();
      let isGameWon = false;
      let unsubscribeGame = null;
      let unsubscribeCards = null;

      // Elementos del DOM
      const adminPanel = document.getElementById("admin-panel");
      const playerPanel = document.getElementById("player-panel");
      const drawButton = document.getElementById("draw-button");
      const resetButton = document.getElementById("reset-button");
      const loadCardButton = document.getElementById("load-card-button");
      const bingoButton = document.getElementById("bingo-button");

      const gameIdDisplay = document.getElementById("game-id-display");
      const prizeDisplay = document.getElementById("prize-display");
      const currentNumberDisplay = document.getElementById(
        "current-number-display"
      );
      const cardsAreaElement = document.getElementById("cards-area");

      const winMessage = document.getElementById("win-message");
      const winMessageText = document.getElementById("win-message-text");

      // Modal (reutilizado para admin pass y buscar cartón)
      const modal = document.getElementById("modal");
      const modalTitle = document.getElementById("modal-title");
      const modalDescription = document.getElementById("modal-description");
      const modalInput = document.getElementById("modal-input");
      const modalError = document.getElementById("modal-error");
      const modalCancelButton = document.getElementById("modal-cancel-button");
      const modalSubmitButton = document.getElementById("modal-submit-button");
      let modalMode = "loadCard"; // 'loadCard' o 'adminPass'

      // Elementos de Admin
      const prizeInput = document.getElementById("prize-input");
      const savePrizeButton = document.getElementById("save-prize-button");
      const gameModeSelect = document.getElementById("game-mode-select");
      const activeCardsListEl = document.getElementById("active-cards-list");
      const activeCardsCountEl = document.getElementById("active-cards-count");
      const adminToggleButton = document.getElementById("admin-toggle-button");

      // Elementos del Tablero
      const calledB_El = document.getElementById("called-B");
      const calledI_El = document.getElementById("called-I");
      const calledN_El = document.getElementById("called-N");
      const calledG_El = document.getElementById("called-G");
      const calledO_El = document.getElementById("called-O");

      // Rangos de Números
      const BINGO_RANGES = {
        0: { min: 1, max: 15 }, // B
        1: { min: 16, max: 30 }, // I
        2: { min: 31, max: 45 }, // N
        3: { min: 46, max: 60 }, // G
        4: { min: 61, max: 75 }, // O
      };

      // --- 1. Inicialización y Autenticación ---
      document.addEventListener("DOMContentLoaded", () => {
        try {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
          setLogLevel("Debug");
          checkAuth();
        } catch (e) {
          console.error("Error al inicializar Firebase:", e);
          gameIdDisplay.textContent = "Error de conexión";
        }

        // Listeners de botones
        resetButton.addEventListener("click", handleNewGame);
        drawButton.addEventListener("click", handleDrawNumber);
        savePrizeButton.addEventListener("click", handleSavePrize);
        loadCardButton.addEventListener("click", promptLoadCard);
        bingoButton.addEventListener("click", handleBingoButton);

        modalCancelButton.addEventListener("click", () =>
          modal.classList.add("hidden")
        );
        modalSubmitButton.addEventListener("click", handleSubmitModal);

        adminToggleButton.addEventListener("click", promptAdminPassword);
      });

      async function checkAuth() {
        try {
          const authToken =
            typeof __initial_auth_token !== "undefined"
              ? __initial_auth_token
              : null;
          if (authToken) {
            await signInWithCustomToken(auth, authToken);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Error de autenticación:", error);
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            setupAppMode(); // Configura el modo (admin/player)
            listenToCurrentGame(); // Empieza a escuchar el juego activo
          } else {
            console.log("Usuario no autenticado.");
          }
        });
      }

      function setupAppMode() {
        // El modo Admin ahora se activa con contraseña
        adminPanel.classList.add("hidden");
        playerPanel.classList.remove("hidden");
      }

      // --- Lógica del Modal (ahora multi-propósito) ---
      function handleSubmitModal() {
        if (modalMode === "loadCard") {
          handleLoadCard();
        } else if (modalMode === "adminPass") {
          checkAdminPassword();
        }
      }

      // --- 2. Lógica de Admin ---

      function promptAdminPassword() {
        modalMode = "adminPass";
        modalTitle.textContent = "Acceso de Administrador";
        modalDescription.textContent =
          "Introduce la contraseña para activar el panel de admin.";
        modalInput.type = "password";
        modalInput.value = "";
        modalError.textContent = "";
        modalSubmitButton.textContent = "Activar";
        modal.classList.remove("hidden");
        modalInput.focus();
      }

      function checkAdminPassword() {
        if (modalInput.value === ADMIN_PASSWORD) {
          isAdmin = true;
          showAdminPanel();
          adminToggleButton.classList.add("hidden");
          modal.classList.add("hidden");
          // Si el listener del juego ya se ejecutó, iniciar listener de cartones
          if (currentGameId) {
            listenToActiveCards();
          }
        } else {
          modalError.textContent = "Contraseña incorrecta.";
        }
      }

      function showAdminPanel() {
        adminPanel.classList.remove("hidden");
        playerPanel.classList.add("hidden");
      }

      async function handleNewGame() {
        console.log("Iniciando nuevo juego...");

        const newGameId = `SORTEO-${
          new Date().toISOString().split("T")[0]
        }-${Math.random().toString(36).substr(2, 5)}`;
        console.log(`Creando nuevo juego con ID: ${newGameId}`);

        const batch = writeBatch(db);
        const cardsCollectionRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          newGameId,
          "cards"
        );

        for (let i = 1; i <= 100; i++) {
          const cardData = generateCardData();
          const cardDataJSON = JSON.stringify(cardData);
          const cardDocRef = doc(cardsCollectionRef, i.toString());
          batch.set(cardDocRef, {
            cardData: cardDataJSON,
            cardId: i.toString(),
            status: "inactive",
          });
        }

        // Guardar modalidad y premio inicial
        const selectedMode = gameModeSelect.value;
        const prize = prizeInput.value || "¡Mucha Suerte!";

        const gameDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          newGameId
        );
        batch.set(gameDocRef, {
          drawnNumbers: [],
          allNumbers: Array.from({ length: 75 }, (_, i) => i + 1),
          gameMode: selectedMode,
          prize: prize,
        });

        const configDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_config",
          "current_game"
        );
        batch.set(configDocRef, { gameId: newGameId });

        try {
          await batch.commit();
          console.log("¡Nuevo juego creado exitosamente!");
          prizeDisplay.textContent = prize; // Actualizar UI local del admin
        } catch (e) {
          console.error("Error al crear nuevo juego:", e);
        }
      }

      async function handleSavePrize() {
        if (!currentGameId || !isAdmin) return;
        const prize = prizeInput.value;
        if (prize.trim() === "") {
          alert("Por favor, introduce un premio válido.");
          return;
        }

        const gameDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId
        );
        try {
          await updateDoc(gameDocRef, { prize: prize });
          console.log("Premio actualizado.");
        } catch (e) {
          console.error("Error al guardar el premio:", e);
        }
      }

      async function handleDrawNumber() {
        if (!currentGameId || isGameWon) return;

        drawButton.disabled = true;
        const gameDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId
        );

        try {
          const gameDoc = await getDoc(gameDocRef);
          if (!gameDoc.exists()) {
            console.error("El documento del juego no existe.");
            drawButton.disabled = false;
            return;
          }

          let { drawnNumbers, allNumbers } = gameDoc.data();
          const availableNumbers = allNumbers.filter(
            (n) => !drawnNumbers.includes(n)
          );

          if (availableNumbers.length === 0) {
            console.log("No hay más números para sortear.");
            return;
          }

          const randIndex = Math.floor(Math.random() * availableNumbers.length);
          const newNumber = availableNumbers[randIndex];

          const newDrawnNumbers = [...drawnNumbers, newNumber];
          await updateDoc(gameDocRef, { drawnNumbers: newDrawnNumbers });

          setTimeout(() => {
            if (!isGameWon) drawButton.disabled = false;
          }, 500);
        } catch (e) {
          console.error("Error al sortear número:", e);
          drawButton.disabled = false;
        }
      }

      // --- 3. Lógica del Jugador ---

      function promptLoadCard() {
        modalMode = "loadCard";
        modalTitle.textContent = "Buscar mi Cartón";
        modalDescription.textContent =
          "Introduce el ID de tu cartón (ej: 1, 45, etc.)";
        modalInput.type = "number";
        modalInput.value = "";
        modalError.textContent = "";
        modalSubmitButton.textContent = "Buscar";
        modal.classList.remove("hidden");
        modalInput.focus();
      }

      async function handleLoadCard() {
        const cardId = modalInput.value.trim();
        if (!cardId || !currentGameId) {
          modalError.textContent = "ID de cartón inválido.";
          return;
        }

        if (localLoadedCards.has(cardId)) {
          modalError.textContent = "Ese cartón ya está cargado.";
          setTimeout(() => modal.classList.add("hidden"), 1000);
          return;
        }

        const cardDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId,
          "cards",
          cardId
        );

        try {
          const cardDoc = await getDoc(cardDocRef);
          if (cardDoc.exists()) {
            const cardData = JSON.parse(cardDoc.data().cardData);
            const cardIndex = localLoadedCards.size;

            localLoadedCards.set(cardId, { data: cardData, index: cardIndex });
            renderCard(cardData, cardIndex, cardId);

            // Reportar cartón como activo
            try {
              await updateDoc(cardDocRef, {
                status: "active",
                lastLoadedAt: serverTimestamp(),
              });
              console.log(`Cartón ${cardId} marcado como activo.`);
            } catch (updateError) {
              console.warn(
                "No se pudo marcar el cartón como activo:",
                updateError
              );
            }

            modal.classList.add("hidden");
          } else {
            modalError.textContent = "Cartón no encontrado en este sorteo.";
          }
        } catch (e) {
          console.error("Error al cargar cartón:", e);
          modalError.textContent = "Error al conectar con la base de datos.";
        }
      }

      function handleBingoButton() {
        if (isGameWon) return; // Alguien ya ganó

        let playerHasWon = false;
        let winningCardId = null;

        // Revisar todos los cartones cargados por este jugador
        localLoadedCards.forEach((card, cardId) => {
          if (checkWin(card.index, cardId)) {
            playerHasWon = true;
            winningCardId = cardId;
          }
        });

        if (playerHasWon) {
          triggerWin(winningCardId);
        } else {
          // Opcional: Mostrar un mensaje de "Aún no ganas"
          winMessageText.textContent = "¡Aún no!";
          winMessage.classList.remove("hidden");
          setTimeout(() => {
            if (!isGameWon) winMessage.classList.add("hidden");
          }, 2000);
        }
      }

      // --- 4. Lógica Sincronizada (Todos) ---

      function listenToCurrentGame() {
        const configDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_config",
          "current_game"
        );

        onSnapshot(
          configDocRef,
          (doc) => {
            if (doc.exists()) {
              const newGameId = doc.data().gameId;

              if (newGameId !== currentGameId) {
                console.log(`Transicionando al juego: ${newGameId}`);
                currentGameId = newGameId;
                gameIdDisplay.textContent = currentGameId;

                if (unsubscribeGame) unsubscribeGame();
                if (unsubscribeCards) unsubscribeCards();

                resetLocalGame();

                listenToGameData();
                if (isAdmin) {
                  listenToActiveCards();
                }
              }
            } else {
              gameIdDisplay.textContent = "No hay juego activo";
            }
          },
          (error) => {
            console.error("Error escuchando el juego actual:", error);
            gameIdDisplay.textContent = "Error de conexión";
          }
        );
      }

      function listenToGameData() {
        if (!currentGameId) return;

        const gameDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId
        );

        unsubscribeGame = onSnapshot(
          gameDocRef,
          (doc) => {
            if (doc.exists()) {
              const { drawnNumbers, gameMode, prize } = doc.data();

              // Sincronizar números
              calledNumbers = new Set(drawnNumbers);
              updateCalledNumbersUI(drawnNumbers);

              // Sincronizar modalidad
              currentGameMode = gameMode || "full_card";
              if (isAdmin) {
                gameModeSelect.value = currentGameMode;
              }

              // Sincronizar premio
              const displayPrize = prize || "¡Mucha Suerte!";
              prizeDisplay.textContent = displayPrize;
              if (isAdmin) {
                prizeInput.value = prize;
              }

              if (drawnNumbers.length === 75) {
                isGameWon = true;
                if (isAdmin) drawButton.disabled = true;
              }
            }
          },
          (error) => {
            console.error("Error escuchando datos del juego:", error);
          }
        );
      }

      function listenToActiveCards() {
        if (!currentGameId || !isAdmin) return;

        const cardsCollectionRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId,
          "cards"
        );

        unsubscribeCards = onSnapshot(
          cardsCollectionRef,
          (querySnapshot) => {
            activeCardsListEl.innerHTML = "";
            let cardIds = [];
            querySnapshot.forEach((doc) => {
              if (doc.data().status === "active") {
                cardIds.push(doc.data().cardId);
              }
            });
            cardIds.sort((a, b) => parseInt(a) - parseInt(b));
            cardIds.forEach((cardId) => {
              const cardTag = document.createElement("span");
              cardTag.className = "active-card-tag";
              cardTag.textContent = cardId;
              activeCardsListEl.appendChild(cardTag);
            });
            activeCardsCountEl.textContent = `(${cardIds.length})`;
          },
          (error) => {
            console.error("Error escuchando cartones activos:", error);
          }
        );
      }

      function resetLocalGame() {
        isGameWon = false;
        calledNumbers.clear();
        localLoadedCards.clear();
        cardsAreaElement.innerHTML = "";
        calledB_El.innerHTML = "";
        calledI_El.innerHTML = "";
        calledN_El.innerHTML = "";
        calledG_El.innerHTML = "";
        calledO_El.innerHTML = "";

        currentNumberDisplay.textContent = "-";
        winMessage.classList.add("hidden");
        if (isAdmin) {
          drawButton.disabled = false;
          activeCardsListEl.innerHTML = "";
          activeCardsCountEl.textContent = "(0)";
          prizeInput.value = "";
          gameModeSelect.value = "full_card";
        }
        prizeDisplay.textContent = "¡Mucha Suerte!";
      }

      // --- 5. Lógica de UI y Renderizado ---

      function updateCalledNumbersUI(drawnNumbers) {
        calledB_El.innerHTML = "";
        calledI_El.innerHTML = "";
        calledN_El.innerHTML = "";
        calledG_El.innerHTML = "";
        calledO_El.innerHTML = "";

        if (drawnNumbers.length === 0) {
          currentNumberDisplay.textContent = "-";
          return;
        }

        const lastNumber = drawnNumbers[drawnNumbers.length - 1];
        currentNumberDisplay.textContent = lastNumber;
        currentNumberDisplay.classList.add("pop");
        setTimeout(() => currentNumberDisplay.classList.remove("pop"), 200);

        const sortedNumbers = [...drawnNumbers].sort((a, b) => a - b);

        sortedNumbers.forEach((number) => {
          const letter = getLetterForNumber(number);
          const numberEl = document.createElement("div");
          numberEl.className = "tote-board-number";
          numberEl.textContent = number;
          switch (letter) {
            case "B":
              calledB_El.appendChild(numberEl);
              break;
            case "I":
              calledI_El.appendChild(numberEl);
              break;
            case "N":
              calledN_El.appendChild(numberEl);
              break;
            case "G":
              calledG_El.appendChild(numberEl);
              break;
            case "O":
              calledO_El.appendChild(numberEl);
              break;
          }
        });
      }

      function handleCellClick(event) {
        if (isGameWon) return; // No marcar si ya ganó alguien

        const cell = event.currentTarget;
        const number = cell.dataset.number;

        if (number === "GRATIS") return; // El gratis no se toca

        // Solo se puede marcar si el número HA SIDO sorteado
        if (calledNumbers.has(parseInt(number, 10))) {
          cell.classList.toggle("marked");
        } else {
          // Opcional: feedback de que no puede marcar
          cell.classList.add("shake");
          setTimeout(() => cell.classList.remove("shake"), 300);
        }
      }

      // --- 6. Lógica del Juego (Generar, Renderizar, Ganar) ---

      function getLetterForNumber(number) {
        if (number <= 15) return "B";
        if (number <= 30) return "I";
        if (number <= 45) return "N";
        if (number <= 60) return "G";
        if (number <= 75) return "O";
        return "";
      }

      function generateCardData() {
        let card = [];
        for (let c = 0; c < 5; c++) {
          let colNumbers = new Set();
          const { min, max } = BINGO_RANGES[c];
          const count = c === 2 ? 4 : 5;
          while (colNumbers.size < count) {
            const num = Math.floor(Math.random() * (max - min + 1)) + min;
            colNumbers.add(num);
          }
          let colArray = Array.from(colNumbers);
          if (c === 2) {
            colArray.splice(2, 0, "GRATIS");
          }
          card.push(colArray);
        }
        return card;
      }

      function renderCard(cardData, cardIndex, cardId) {
        const cardWrapper = document.createElement("div");
        cardWrapper.id = `card-${cardIndex}`;
        cardWrapper.dataset.cardId = cardId;
        cardWrapper.className = "bg-white p-4 rounded-lg shadow-inner";

        const title = document.createElement("h3");
        title.className = "text-xl font-bold text-center text-purple-600 mb-3";
        title.textContent = `Cartón #${cardId}`;
        cardWrapper.appendChild(title);

        const grid = document.createElement("div");
        grid.className = "bingo-card-grid";

        for (let r = 0; r < 5; r++) {
          for (let c = 0; c < 5; c++) {
            const number = cardData[c][r];
            const cell = document.createElement("div");
            cell.classList.add("bingo-cell");
            cell.textContent = number;
            cell.dataset.col = c;
            cell.dataset.row = r;
            cell.dataset.number = number;
            cell.dataset.cardIndex = cardIndex;

            if (number === "GRATIS") {
              cell.classList.add("free", "marked");
            } else {
              // Añadir el listener para marcado manual
              cell.addEventListener("click", handleCellClick);
            }

            grid.appendChild(cell);
          }
        }
        cardWrapper.appendChild(grid);
        cardsAreaElement.appendChild(cardWrapper);
      }

      // --- LÓGICA DE VICTORIA MEJORADA ---
      function checkWin(cardIndex, cardId) {
        const cardContainer = document.getElementById(`card-${cardIndex}`);
        if (!cardContainer) return false;

        const markedCells = new Set();
        cardContainer.querySelectorAll(".bingo-cell.marked").forEach((cell) => {
          markedCells.add(`${cell.dataset.col}-${cell.dataset.row}`);
        });

        // Lógica de victoria basada en la modalidad de juego
        switch (currentGameMode) {
          case "full_card":
            return checkWinFullCard(markedCells);
          case "h_line":
            return checkWinHorizontalLine(markedCells);
          case "v_line":
            return checkWinVerticalLine(markedCells);
          case "corners":
            return checkWinCorners(markedCells);
          default:
            return false;
        }
      }

      function checkWinFullCard(markedCells) {
        return markedCells.size === 25;
      }

      function checkWinHorizontalLine(markedCells) {
        for (let r = 0; r < 5; r++) {
          if ([...Array(5).keys()].every((c) => markedCells.has(`${c}-${r}`))) {
            return true;
          }
        }
        return false;
      }

      function checkWinVerticalLine(markedCells) {
        for (let c = 0; c < 5; c++) {
          if ([...Array(5).keys()].every((r) => markedCells.has(`${c}-${r}`))) {
            return true;
          }
        }
        return false;
      }

      function checkWinCorners(markedCells) {
        return (
          markedCells.has("0-0") &&
          markedCells.has("4-0") &&
          markedCells.has("0-4") &&
          markedCells.has("4-4")
        );
      }

      function triggerWin(cardId) {
        if (isGameWon) return;

        isGameWon = true;
        winMessageText.textContent = `¡BINGO! (Cartón #${cardId})`;
        winMessage.classList.remove("hidden");

        if (isAdmin) {
          drawButton.disabled = true;
        }
        // Desactivar botones de jugador
        bingoButton.disabled = true;
        bingoButton.classList.add("opacity-50");
        loadCardButton.disabled = true;
        loadCardButton.classList.add("opacity-50");
      }
    </script>
  </body>
</html>
