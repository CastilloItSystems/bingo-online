<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bingo Plus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Paleta de Colores Bingo Plus */
      :root {
        --color-bg: #f3e8ff; /* bg-purple-100 */
        --color-bg-alt: #ffffff; /* bg-white */
        --color-primary: #7e22ce; /* text-purple-700 */
        --color-primary-dark: #581c87; /* text-purple-900 */
        --color-secondary: #e11d48; /* text-pink-600 */
        --color-accent: #f59e0b; /* text-amber-500 */
        --color-text: #3730a3; /* text-indigo-800 */
        --color-admin-bg: #fdf4ff; /* bg-fuchsia-50 */
      }

      body {
        background-color: var(--color-bg);
        color: var(--color-text);
      }

      /* Estilo llamativo para BINGO PLUS */
      .logo-title {
        color: var(--color-accent);
        text-shadow: 2px 2px 4px var(--color-primary-dark);
      }

      .bingo-card-grid {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 0.5rem;
        max-width: 28rem;
        margin: auto;
      }
      .bingo-cell {
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        border-radius: 0.5rem;
        background-color: var(--color-bg-alt);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease-in-out;
        user-select: none;
        cursor: pointer; /* Indicar que es clickeable */
      }
      .bingo-cell:hover {
        transform: scale(1.05);
      }
      .bingo-cell.marked {
        background-color: var(--color-secondary);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(225, 29, 72, 0.4);
      }
      .bingo-cell.free {
        background-color: var(--color-accent);
        color: white;
        font-size: 1rem;
        line-height: 1.2;
      }
      .bingo-cell.shake {
        animation: shake 0.3s;
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }
      /* Estilo llamativo para cabecera BINGO */
      .bingo-header-cell {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.25rem;
        font-weight: 800;
        color: var(--color-primary);
        text-shadow: 1px 1px 2px var(--color-accent);
      }
      #current-number-display {
        width: 10rem;
        height: 10rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        background-color: var(--color-bg-alt);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        color: var(--color-primary-dark);
        font-size: 5rem;
        font-weight: 800;
        line-height: 1;
        transition: transform 0.2s ease;
      }
      #current-number-display.pop {
        transform: scale(1.1);
      }
      #win-message {
        transition: all 0.3s ease;
      }
      #win-message.bingo-win {
        animation: pulse-win 1s infinite;
      }
      @keyframes pulse-win {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.8;
          transform: scale(1.1);
        }
      }
      #modal {
        background-color: rgba(0, 0, 0, 0.5);
      }
      #active-cards-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        max-height: 200px;
        overflow-y: auto;
        background-color: #f3e8ff; /* bg-purple-100 */
        padding: 0.75rem;
        border-radius: 0.5rem;
      }
      .active-card-tag {
        background-color: #ede9fe; /* bg-violet-100 */
        color: #5b21b6; /* text-violet-800 */
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
      }
      .tote-board-number {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: white;
        color: var(--color-primary);
        font-weight: 600;
        font-size: 1rem;
        border-radius: 0.375rem;
        padding: 0.25rem 0;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      /* Botones con nueva paleta */
      .btn {
        font-weight: bold;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn-primary {
        background-color: var(--color-primary);
        color: white;
      }
      .btn-primary:hover:not(:disabled) {
        background-color: var(--color-primary-dark);
      }
      .btn-secondary {
        background-color: var(--color-secondary);
        color: white;
      }
      .btn-secondary:hover:not(:disabled) {
        background-color: #be123c; /* pink-700 */
      }
      .btn-accent {
        background-color: var(--color-accent);
        color: white;
      }
      .btn-accent:hover:not(:disabled) {
        background-color: #d97706; /* amber-600 */
      }
      .btn-green {
        background-color: #16a34a; /* green-600 */
        color: white;
      }
      .btn-green:hover:not(:disabled) {
        background-color: #15803d; /* green-700 */
      }
      .btn-gray {
        background-color: #9ca3af; /* bg-gray-400 */
        color: #1f2937; /* text-gray-800 */
      }
      .btn-gray:hover:not(:disabled) {
        background-color: #6b7280; /* bg-gray-500 */
      }
      .btn-outline {
        background-color: transparent;
        color: var(--color-primary);
        border: 2px solid var(--color-primary);
      }
      .btn-outline:hover:not(:disabled) {
        background-color: var(--color-primary);
        color: white;
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <!-- Modal para buscar cartón (oculto por defecto) -->
    <div
      id="modal"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl text-center"
      >
        <h3 id="modal-title" class="text-2xl font-bold mb-4">
          Buscar mi Cartón
        </h3>
        <p id="modal-description" class="text-gray-600 mb-4">
          Introduce el ID de tu cartón (ej: 1, 45, etc.)
        </p>
        <input
          id="modal-input"
          type="number"
          class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-lg focus:border-purple-500 focus:ring-0"
          placeholder="Ej: 5"
        />
        <div id="modal-error" class="text-red-500 text-sm mt-2 h-4"></div>
        <div class="flex gap-4 mt-4">
          <button id="modal-cancel-button" class="flex-1 btn btn-gray">
            Cancelar
          </button>
          <button id="modal-submit-button" class="flex-1 btn btn-primary">
            Buscar
          </button>
        </div>
      </div>
    </div>

    <div class="max-w-7xl mx-auto">
      <h1
        id="main-title"
        class="logo-title text-4xl md:text-6xl font-extrabold text-center mb-4"
      >
        BINGO PLUS
      </h1>

      <!-- Info del Juego (ID, Premio, Modalidad) -->
      <div
        class="text-center mb-4 p-4 bg-white rounded-xl shadow-md max-w-lg mx-auto space-y-2"
      >
        <div class="flex justify-between items-center">
          <span class="text-lg font-semibold text-gray-700"
            >ID del Sorteo:</span
          >
          <span
            id="game-id-display"
            class="text-lg font-bold text-pink-600 bg-pink-50 px-3 py-1 rounded-full"
            >Cargando...</span
          >
        </div>
        <div class="flex justify-between items-center">
          <span class="text-lg font-semibold text-gray-700">Premio:</span>
          <span
            id="prize-display"
            class="text-lg font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full"
            >¡Mucha Suerte!</span
          >
        </div>
        <!-- NUEVO: Modalidad de Juego para el Jugador -->
        <div class="flex justify-between items-center">
          <span class="text-lg font-semibold text-gray-700">Modalidad:</span>
          <span
            id="game-mode-display"
            class="text-lg font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-full"
            >---</span
          >
        </div>
      </div>

      <!-- Botón para forzar modo Admin -->
      <div id="admin-toggle-button-wrapper" class="text-center mb-4">
        <button id="admin-toggle-button" class="btn btn-gray text-xs py-2 px-4">
          Activar Modo Admin
        </button>
      </div>

      <!-- Mensaje de BINGO (oculto por defecto) -->
      <div id="win-message" class="hidden text-center mb-6 p-4 rounded-lg">
        <span
          id="win-message-text"
          class="text-4xl md:text-5xl font-extrabold text-amber-500"
          >¡B I N G O!</span
        >
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Columna Izquierda: Sorteo y Números Sorteados -->
        <div
          class="lg:col-span-1 bg-admin-bg p-6 rounded-2xl shadow-lg flex flex-col items-center gap-6 order-2 lg:order-1"
        >
          <!-- Número Sorteado Actual -->
          <div class="text-center">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">
              Número Sorteado
            </h2>
            <div id="current-number-display" class="mx-auto">-</div>
          </div>

          <!-- Panel de Administrador (oculto por defecto) -->
          <div id="admin-panel" class="hidden w-full space-y-4">
            <!-- NUEVO: Área de Notificación de Admin -->
            <div
              id="admin-notification-area"
              class="hidden p-3 rounded-lg text-center font-semibold"
            ></div>

            <!-- NUEVO: Botones de Confirmación de Bingo (ocultos) -->
            <div
              id="admin-confirm-buttons"
              class="hidden flex flex-col sm:flex-row gap-4 w-full"
            >
              <button
                id="reject-win-button"
                class="flex-1 btn btn-secondary text-lg"
              >
                Rechazar Bingo
              </button>
              <button
                id="confirm-win-button"
                class="flex-1 btn btn-green text-lg"
              >
                Confirmar Ganador
              </button>
            </div>

            <!-- Sorteo Manual -->
            <button id="draw-button" class="w-full btn btn-primary text-lg">
              Sortear (Manual)
            </button>
            <!-- Sorteo Automático -->
            <div class="p-4 bg-white rounded-lg shadow-sm">
              <label
                for="auto-draw-seconds"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Sorteo Automático (segundos):</label
              >
              <div class="flex gap-2">
                <input
                  id="auto-draw-seconds"
                  type="number"
                  value="5"
                  class="w-1/3 border-2 border-gray-300 rounded-lg p-2 focus:border-purple-500 focus:ring-0"
                  placeholder="Ej: 5"
                />
                <button id="auto-draw-button" class="flex-1 btn btn-outline">
                  Iniciar Auto
                </button>
              </div>
            </div>
            <button id="reset-button" class="w-full btn btn-accent text-lg">
              Nuevo Juego
            </button>

            <!-- Configuración de Juego (Premio y Modalidad) -->
            <div class="space-y-4 p-4 bg-white rounded-lg shadow-sm">
              <!-- Modalidad -->
              <div>
                <label
                  for="game-mode-select"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Modalidad de Juego:</label
                >
                <select
                  id="game-mode-select"
                  class="w-full border-2 border-gray-300 rounded-lg p-2 focus:border-purple-500 focus:ring-0"
                >
                  <option value="full_card">Cartón Lleno</option>
                  <option value="h_line">Línea Horizontal</option>
                  <option value="v_line">Línea Vertical</option>
                  <option value="corners">Cuatro Esquinas</option>
                </select>
              </div>
              <!-- Premio -->
              <div>
                <label
                  for="prize-input"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >Premio Actual:</label
                >
                <div class="flex gap-2">
                  <input
                    id="prize-input"
                    type="text"
                    class="flex-1 w-full border-2 border-gray-300 rounded-lg p-2 focus:border-purple-500 focus:ring-0"
                    placeholder="Ej: 50 Bs"
                  />
                  <button
                    id="save-prize-button"
                    class="btn btn-primary font-semibold px-4 rounded-lg"
                  >
                    Guardar
                  </button>
                </div>
              </div>
            </div>

            <!-- Cartones Activos -->
            <div class="space-y-2">
              <h3 class="text-xl font-bold text-center text-gray-700">
                Cartones Activos
                <span
                  id="active-cards-count"
                  class="text-lg font-semibold text-purple-600"
                  >(0)</span
                >
              </h3>
              <div
                id="active-cards-list"
                class="border rounded-lg p-3 bg-white h-32 overflow-y-auto"
              >
                <!-- Los cartones activos se listarán aquí -->
              </div>
            </div>

            <p class="text-xs text-center text-gray-500">
              Estás en modo Administrador.
            </p>
          </div>

          <!-- Tablero de Números Sorteados (Tote Board) -->
          <div class="w-full">
            <h3 class="text-xl font-bold text-center text-gray-700 mb-4">
              Tablero de Sorteo
            </h3>
            <div
              class="grid grid-cols-5 gap-2 text-center bg-white p-2 rounded-lg shadow-inner"
            >
              <!-- Encabezados -->
              <div class="text-2xl font-extrabold text-purple-700">B</div>
              <div class="text-2xl font-extrabold text-purple-700">I</div>
              <div class="text-2xl font-extrabold text-purple-700">N</div>
              <div class="text-2xl font-extrabold text-purple-700">G</div>
              <div class="text-2xl font-extrabold text-purple-700">O</div>

              <!-- Contenedores de Números -->
              <div
                id="called-B"
                class="flex flex-col-reverse space-y-1 space-y-reverse h-40 overflow-y-auto p-1 border border-gray-200 rounded-md"
              ></div>
              <div
                id="called-I"
                class="flex flex-col-reverse space-y-1 space-y-reverse h-40 overflow-y-auto p-1 border border-gray-200 rounded-md"
              ></div>
              <div
                id="called-N"
                class="flex flex-col-reverse space-y-1 space-y-reverse h-40 overflow-y-auto p-1 border border-gray-200 rounded-md"
              ></div>
              <div
                id="called-G"
                class="flex flex-col-reverse space-y-1 space-y-reverse h-40 overflow-y-auto p-1 border border-gray-200 rounded-md"
              ></div>
              <div
                id="called-O"
                class="flex flex-col-reverse space-y-1 space-y-reverse h-40 overflow-y-auto p-1 border border-gray-200 rounded-md"
              ></div>
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Cartones de Bingo -->
        <div
          class="lg:col-span-2 bg-purple-200 p-6 rounded-2xl shadow-lg order-1 lg:order-2"
        >
          <div class="max-w-md mx-auto">
            <!-- Panel de Jugador -->
            <div id="player-panel" class="mb-4 space-y-4 text-center">
              <div class="flex gap-4">
                <button
                  id="load-card-button"
                  class="flex-1 btn btn-primary text-lg"
                >
                  Buscar mi Cartón
                </button>
                <!-- NUEVO: Botón de Sincronización -->
                <button
                  id="sync-cards-button"
                  class="flex-1 btn btn-outline text-lg"
                >
                  Sincronizar
                </button>
              </div>
              <button
                id="bingo-button"
                class="w-full btn btn-secondary text-2xl py-4 animate-pulse"
              >
                ¡BINGO!
              </button>
            </div>

            <!-- Encabezado BINGO -->
            <div class="grid grid-cols-5 gap-2 mb-2">
              <div class="bingo-header-cell">B</div>
              <div class="bingo-header-cell">I</div>
              <div class="bingo-header-cell">N</div>
              <div class="bingo-header-cell">G</div>
              <div class="bingo-header-cell">O</div>
            </div>

            <!-- Área de Cartones de Bingo -->
            <div id="cards-area" class="space-y-6">
              <!-- Los cartones de bingo se generarán aquí con JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Importa las funciones que necesitas
      import {
        initializeApp,
        setLogLevel,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        onSnapshot,
        collection,
        writeBatch,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- CONTRASEÑA DE ADMIN ---
      // ¡Cámbiala aquí si lo deseas!
      const ADMIN_PASSWORD = "1234";

      // Pega aquí la configuración de TU proyecto de Firebase
      // O usa la variable __firebase_config para probar en el 'Preview'
      const firebaseConfig = {
        apiKey: "AIzaSyAsfyZK5Gv7XkJYfh0GlJHRfMFBWzNQjmM",
        authDomain: "bingoclaravirginia.firebaseapp.com",
        projectId: "bingoclaravirginia",
        storageBucket: "bingoclaravirginia.firebasestorage.app",
        messagingSenderId: "290520708699",
        appId: "1:290520708699:web:a37d42aad57ea63228717e",
        measurementId: "G-YB1SG1JH6H",
      };

      const appId = typeof __app_id !== "undefined" ? __app_id : "bingo-plus";

      // Inicializa Firebase
      let app, auth, db;
      let userId = null;
      let isAdmin = false;

      // Estado del juego
      let currentGameId = null;
      let currentGameMode = "full_card";
      let localLoadedCards = new Map();
      let calledNumbers = new Set();
      let isGameWon = false; // Se vuelve 'true' solo cuando el admin confirma
      let autoDrawInterval = null;
      let pendingBingoCheck = null; // Almacena el ID del cartón que está siendo verificado

      let unsubscribeGame = null;
      let unsubscribeActiveCards = null;
      let unsubscribeBingoChecks = null;

      // Elementos del DOM
      const adminPanel = document.getElementById("admin-panel");
      const playerPanel = document.getElementById("player-panel");
      const drawButton = document.getElementById("draw-button");
      const autoDrawButton = document.getElementById("auto-draw-button");
      const autoDrawSecondsInput = document.getElementById("auto-draw-seconds");
      const resetButton = document.getElementById("reset-button");
      const loadCardButton = document.getElementById("load-card-button");
      const bingoButton = document.getElementById("bingo-button");
      const syncCardsButton = document.getElementById("sync-cards-button"); // NUEVO

      const gameIdDisplay = document.getElementById("game-id-display");
      const prizeDisplay = document.getElementById("prize-display");
      const gameModeDisplay = document.getElementById("game-mode-display"); // NUEVO
      const currentNumberDisplay = document.getElementById(
        "current-number-display"
      );
      const cardsAreaElement = document.getElementById("cards-area");

      const winMessage = document.getElementById("win-message");
      const winMessageText = document.getElementById("win-message-text");

      // Modal (reutilizado para admin pass y buscar cartón)
      const modal = document.getElementById("modal");
      const modalTitle = document.getElementById("modal-title");
      const modalDescription = document.getElementById("modal-description");
      const modalInput = document.getElementById("modal-input");
      const modalError = document.getElementById("modal-error");
      const modalCancelButton = document.getElementById("modal-cancel-button");
      const modalSubmitButton = document.getElementById("modal-submit-button");
      let modalMode = "loadCard"; // 'loadCard' o 'adminPass'

      // Elementos de Admin
      const prizeInput = document.getElementById("prize-input");
      const savePrizeButton = document.getElementById("save-prize-button");
      const gameModeSelect = document.getElementById("game-mode-select");
      const activeCardsListEl = document.getElementById("active-cards-list");
      const activeCardsCountEl = document.getElementById("active-cards-count");
      const adminToggleButton = document.getElementById("admin-toggle-button");
      // NUEVOS elementos de Admin
      const adminNotificationArea = document.getElementById(
        "admin-notification-area"
      );
      const adminConfirmButtons = document.getElementById(
        "admin-confirm-buttons"
      );
      const confirmWinButton = document.getElementById("confirm-win-button");
      const rejectWinButton = document.getElementById("reject-win-button");

      // Elementos del Tablero
      const calledB_El = document.getElementById("called-B");
      const calledI_El = document.getElementById("called-I");
      const calledN_El = document.getElementById("called-N");
      const calledG_El = document.getElementById("called-G");
      const calledO_El = document.getElementById("called-O");

      // Rangos de Números
      const BINGO_RANGES = {
        0: { min: 1, max: 15 }, // B
        1: { min: 16, max: 30 }, // I
        2: { min: 31, max: 45 }, // N
        3: { min: 46, max: 60 }, // G
        4: { min: 61, max: 75 }, // O
      };
      const GAME_MODE_NAMES = {
        full_card: "Cartón Lleno",
        h_line: "Línea Horizontal",
        v_line: "Línea Vertical",
        corners: "Cuatro Esquinas",
      };

      // --- 1. Inicialización y Autenticación ---
      document.addEventListener("DOMContentLoaded", () => {
        try {
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);
          setLogLevel("Debug");
          checkAuth();
        } catch (e) {
          console.error("Error al inicializar Firebase:", e);
          gameIdDisplay.textContent = "Error de conexión";
        }

        // Listeners de botones
        resetButton.addEventListener("click", handleNewGame);
        drawButton.addEventListener("click", () => handleDrawNumber(false)); // false = no es auto
        autoDrawButton.addEventListener("click", toggleAutoDraw);
        savePrizeButton.addEventListener("click", handleSavePrize);

        loadCardButton.addEventListener("click", promptLoadCard);
        syncCardsButton.addEventListener("click", syncAllCards); // NUEVO
        bingoButton.addEventListener("click", handleBingoButton); // MODIFICADO

        modalCancelButton.addEventListener("click", () =>
          modal.classList.add("hidden")
        );
        modalSubmitButton.addEventListener("click", handleSubmitModal);

        adminToggleButton.addEventListener("click", promptAdminPassword);

        // NUEVOS Listeners de Admin
        confirmWinButton.addEventListener("click", handleConfirmWin);
        rejectWinButton.addEventListener("click", handleRejectWin);
      });

      async function checkAuth() {
        try {
          const authToken =
            typeof __initial_auth_token !== "undefined"
              ? __initial_auth_token
              : null;
          if (authToken) {
            await signInWithCustomToken(auth, authToken);
          } else {
            await signInAnonymously(auth);
          }
        } catch (error) {
          console.error("Error de autenticación:", error);
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
            setupAppMode();
            listenToCurrentGame();
          } else {
            console.log("Usuario no autenticado.");
          }
        });
      }

      function setupAppMode() {
        adminPanel.classList.add("hidden");
        playerPanel.classList.remove("hidden");
      }

      // --- Lógica del Modal ---
      function handleSubmitModal() {
        if (modalMode === "loadCard") {
          handleLoadCard();
        } else if (modalMode === "adminPass") {
          checkAdminPassword();
        }
      }

      // --- 2. Lógica de Admin ---

      function promptAdminPassword() {
        modalMode = "adminPass";
        modalTitle.textContent = "Acceso de Administrador";
        modalDescription.textContent =
          "Introduce la contraseña para activar el panel de admin.";
        modalInput.type = "password";
        modalInput.value = "";
        modalError.textContent = "";
        modalSubmitButton.textContent = "Activar";
        modal.classList.remove("hidden");
        modalInput.focus();
      }

      function checkAdminPassword() {
        if (modalInput.value === ADMIN_PASSWORD) {
          isAdmin = true;
          showAdminPanel();
          adminToggleButton.classList.add("hidden");
          modal.classList.add("hidden");
          if (currentGameId) {
            listenToActiveCards();
          }
        } else {
          modalError.textContent = "Contraseña incorrecta.";
        }
      }

      function showAdminPanel() {
        adminPanel.classList.remove("hidden");
        playerPanel.classList.add("hidden");
      }

      async function handleNewGame() {
        console.log("Iniciando nuevo juego...");

        if (autoDrawInterval) stopAutoDraw();

        const newGameId = `SORTEO-${
          new Date().toISOString().split("T")[0]
        }-${Math.random().toString(36).substr(2, 5)}`;
        console.log(`Creando nuevo juego con ID: ${newGameId}`);

        const batch = writeBatch(db);
        const cardsCollectionRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          newGameId,
          "cards"
        );

        for (let i = 1; i <= 100; i++) {
          const cardData = generateCardData();
          const cardDataJSON = JSON.stringify(cardData);
          const cardDocRef = doc(cardsCollectionRef, i.toString());
          batch.set(cardDocRef, {
            cardData: cardDataJSON,
            cardId: i.toString(),
            status: "inactive",
            bingoCheck: null, // Resetear estado de check
          });
        }

        const selectedMode = gameModeSelect.value;
        const prize = prizeInput.value || "¡Mucha Suerte!";

        const gameDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          newGameId
        );
        batch.set(gameDocRef, {
          drawnNumbers: [],
          allNumbers: Array.from({ length: 75 }, (_, i) => i + 1),
          gameMode: selectedMode,
          prize: prize,
          gameStatus: "playing", // NUEVO: Estado del juego
          winnerCardId: null,
        });

        const configDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_config",
          "current_game"
        );
        batch.set(configDocRef, { gameId: newGameId });

        try {
          await batch.commit();
          console.log("¡Nuevo juego creado exitosamente!");
          prizeDisplay.textContent = prize;
          gameModeDisplay.textContent = GAME_MODE_NAMES[selectedMode];
        } catch (e) {
          console.error("Error al crear nuevo juego:", e);
        }
      }

      async function handleSavePrize() {
        if (!currentGameId || !isAdmin) return;
        const prize = prizeInput.value;
        if (prize.trim() === "") return;

        const gameDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId
        );
        try {
          await updateDoc(gameDocRef, { prize: prize });
          console.log("Premio actualizado.");
        } catch (e) {
          console.error("Error al guardar el premio:", e);
        }
      }

      function toggleAutoDraw() {
        if (autoDrawInterval) {
          stopAutoDraw();
        } else {
          startAutoDraw();
        }
      }

      function startAutoDraw() {
        drawButton.disabled = true;
        autoDrawButton.textContent = "Detener Auto";
        autoDrawButton.classList.remove("btn-outline");
        autoDrawButton.classList.add("btn-secondary");

        handleDrawNumber(true); // Saca el primer número inmediatamente

        const seconds = parseInt(autoDrawSecondsInput.value, 10) || 5;
        autoDrawInterval = setInterval(
          () => handleDrawNumber(true),
          seconds * 1000
        );
      }

      function stopAutoDraw() {
        clearInterval(autoDrawInterval);
        autoDrawInterval = null;
        if (!isGameWon && !pendingBingoCheck) {
          // Solo reactivar si no hay un ganador o check pendiente
          drawButton.disabled = false;
        }
        autoDrawButton.textContent = "Iniciar Auto";
        autoDrawButton.classList.remove("btn-secondary");
        autoDrawButton.classList.add("btn-outline");
      }

      async function handleDrawNumber(isAuto = false) {
        if (!currentGameId || isGameWon || pendingBingoCheck) return;

        if (!isAuto) drawButton.disabled = true;

        const gameDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId
        );

        try {
          const gameDoc = await getDoc(gameDocRef);
          if (!gameDoc.exists()) {
            console.error("El documento del juego no existe.");
            if (!isAuto) drawButton.disabled = false;
            return;
          }

          let { drawnNumbers, allNumbers } = gameDoc.data();
          const availableNumbers = allNumbers.filter(
            (n) => !drawnNumbers.includes(n)
          );

          if (availableNumbers.length === 0) {
            console.log("No hay más números para sortear.");
            if (autoDrawInterval) stopAutoDraw();
            return;
          }

          const randIndex = Math.floor(Math.random() * availableNumbers.length);
          const newNumber = availableNumbers[randIndex];

          const newDrawnNumbers = [...drawnNumbers, newNumber];
          await updateDoc(gameDocRef, { drawnNumbers: newDrawnNumbers });

          if (!isAuto) {
            setTimeout(() => {
              if (!isGameWon && !pendingBingoCheck) drawButton.disabled = false;
            }, 500);
          }
        } catch (e) {
          console.error("Error al sortear número:", e);
          if (!isAuto) drawButton.disabled = false;
        }
      }

      // --- 3. Lógica del Jugador ---

      function promptLoadCard() {
        modalMode = "loadCard";
        modalTitle.textContent = "Buscar mi Cartón";
        modalDescription.textContent =
          "Introduce el ID de tu cartón (ej: 1, 45, etc.)";
        modalInput.type = "number";
        modalInput.value = "";
        modalError.textContent = "";
        modalSubmitButton.textContent = "Buscar";
        modal.classList.remove("hidden");
        modalInput.focus();
      }

      async function handleLoadCard() {
        const cardId = modalInput.value.trim();
        if (!cardId || !currentGameId) {
          modalError.textContent = "ID de cartón inválido.";
          return;
        }

        if (localLoadedCards.has(cardId)) {
          modalError.textContent = "Ese cartón ya está cargado.";
          setTimeout(() => modal.classList.add("hidden"), 1000);
          return;
        }

        const cardDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId,
          "cards",
          cardId
        );

        try {
          const cardDoc = await getDoc(cardDocRef);
          if (cardDoc.exists()) {
            const cardData = JSON.parse(cardDoc.data().cardData);
            const cardIndex = localLoadedCards.size;

            localLoadedCards.set(cardId, { data: cardData, index: cardIndex });
            renderCard(cardData, cardIndex, cardId);

            // Sincronizar el cartón recién cargado
            syncSingleCard(cardId);

            try {
              await updateDoc(cardDocRef, {
                status: "active",
                lastLoadedAt: serverTimestamp(),
              });
              console.log(`Cartón ${cardId} marcado como activo.`);
            } catch (updateError) {
              console.warn(
                "No se pudo marcar el cartón como activo:",
                updateError
              );
            }

            modal.classList.add("hidden");
          } else {
            modalError.textContent = "Cartón no encontrado en este sorteo.";
          }
        } catch (e) {
          console.error("Error al cargar cartón:", e);
          modalError.textContent = "Error al conectar con la base de datos.";
        }
      }

      // NUEVO: Sincroniza todos los cartones cargados por el jugador
      function syncAllCards() {
        localLoadedCards.forEach((card, cardId) => {
          syncSingleCard(cardId);
        });
      }

      // NUEVO: Sincroniza un cartón específico
      function syncSingleCard(cardId) {
        const card = localLoadedCards.get(cardId);
        if (!card) return;

        const cardContainer = document.getElementById(`card-${card.index}`);
        if (!cardContainer) return;

        cardContainer.querySelectorAll(".bingo-cell").forEach((cell) => {
          const number = cell.dataset.number;
          if (number === "GRATIS") {
            cell.classList.add("marked");
            return;
          }

          if (calledNumbers.has(parseInt(number, 10))) {
            cell.classList.add("marked");
          }
        });
      }

      // MODIFICADO: El jugador solo solicita la verificación
      async function handleBingoButton() {
        if (isGameWon || localLoadedCards.size === 0) return;

        // El jugador solo puede pedir un check por cartón
        bingoButton.disabled = true;
        winMessageText.textContent = "Verificando tu BINGO con el admin...";
        winMessage.classList.add("hidden"); // Ocultar mensaje anterior
        winMessage.classList.remove("bg-red-200", "text-red-800", "bingo-win");
        winMessage.classList.add("bg-yellow-100", "text-yellow-700");
        winMessage.classList.remove("hidden");

        // Por simplicidad, solo chequeamos el primer cartón cargado.
        // Una app más compleja permitiría elegir cuál cartón cantar.
        const firstCardId = localLoadedCards.keys().next().value;

        if (firstCardId) {
          await requestBingoCheck(firstCardId);
        } else {
          bingoButton.disabled = false;
          winMessage.classList.add("hidden");
        }
      }

      // NUEVO: El jugador escribe en la BD que quiere un check
      async function requestBingoCheck(cardId) {
        const cardDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId,
          "cards",
          cardId
        );
        try {
          // Notifica al admin
          await updateDoc(cardDocRef, { bingoCheck: "pending" });
        } catch (e) {
          console.error("Error al solicitar check de BINGO:", e);
          bingoButton.disabled = false; // Permitir reintentar si falla
          winMessage.classList.add("hidden");
        }
      }

      // --- 4. Lógica Sincronizada (Todos) ---

      function listenToCurrentGame() {
        const configDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_config",
          "current_game"
        );

        onSnapshot(
          configDocRef,
          (doc) => {
            if (doc.exists()) {
              const newGameId = doc.data().gameId;

              if (newGameId !== currentGameId) {
                console.log(`Transicionando al juego: ${newGameId}`);
                currentGameId = newGameId;
                gameIdDisplay.textContent = currentGameId;

                if (unsubscribeGame) unsubscribeGame();
                if (unsubscribeActiveCards) unsubscribeActiveCards();
                if (unsubscribeBingoChecks) unsubscribeBingoChecks();

                resetLocalGame();

                listenToGameData();
                listenForBingoChecks(); // NUEVO: Todos escuchan
                if (isAdmin) {
                  listenToActiveCards();
                }
              }
            } else {
              gameIdDisplay.textContent = "No hay juego activo";
            }
          },
          (error) => {
            console.error("Error escuchando el juego actual:", error);
            gameIdDisplay.textContent = "Error de conexión";
          }
        );
      }

      function listenToGameData() {
        if (!currentGameId) return;

        const gameDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId
        );

        unsubscribeGame = onSnapshot(
          gameDocRef,
          (doc) => {
            if (doc.exists()) {
              const {
                drawnNumbers,
                gameMode,
                prize,
                gameStatus,
                winnerCardId,
              } = doc.data();

              calledNumbers = new Set(drawnNumbers);
              updateCalledNumbersUI(drawnNumbers);

              currentGameMode = gameMode || "full_card";
              gameModeDisplay.textContent = GAME_MODE_NAMES[currentGameMode];
              if (isAdmin) {
                gameModeSelect.value = currentGameMode;
              }

              const displayPrize = prize || "¡Mucha Suerte!";
              prizeDisplay.textContent = displayPrize;
              if (isAdmin) {
                prizeInput.value = prize;
              }

              // Lógica de juego terminado (confirmado por admin)
              if (gameStatus === "finished") {
                isGameWon = true;
                if (autoDrawInterval) stopAutoDraw();
                if (isAdmin) {
                  drawButton.disabled = true;
                  autoDrawButton.disabled = true;
                  adminNotificationArea.classList.add("hidden");
                  adminConfirmButtons.classList.add("hidden");
                }
                // Desactivar botones de jugador
                bingoButton.disabled = true;
                loadCardButton.disabled = true;
                syncCardsButton.disabled = true;

                winMessageText.textContent = `¡BINGO! (Cartón #${
                  winnerCardId || "Ganador"
                })`;
                winMessage.classList.add("bingo-win", "bg-transparent");
                winMessage.classList.remove("bg-yellow-100", "text-yellow-700");
                winMessage.classList.remove("hidden");
              } else {
                // Si el juego está activo, asegurarse de que los botones estén habilitados
                // (a menos que haya un check pendiente)
                if (!pendingBingoCheck && !isGameWon) {
                  if (isAdmin) drawButton.disabled = false;
                  bingoButton.disabled = false;
                  loadCardButton.disabled = false;
                  syncCardsButton.disabled = false;
                }
              }

              if (drawnNumbers.length === 75 && gameStatus !== "finished") {
                if (autoDrawInterval) stopAutoDraw();
                if (isAdmin) drawButton.disabled = true;
              }
            }
          },
          (error) => {
            console.error("Error escuchando datos del juego:", error);
          }
        );
      }

      function listenToActiveCards() {
        if (!currentGameId || !isAdmin) return;
        if (unsubscribeActiveCards) unsubscribeActiveCards();

        const cardsCollectionRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId,
          "cards"
        );

        unsubscribeActiveCards = onSnapshot(
          cardsCollectionRef,
          (querySnapshot) => {
            activeCardsListEl.innerHTML = "";
            let cardIds = [];
            querySnapshot.forEach((doc) => {
              if (doc.data().status === "active") {
                cardIds.push(doc.data().cardId);
              }
            });
            cardIds.sort((a, b) => parseInt(a) - b);
            cardIds.forEach((cardId) => {
              const cardTag = document.createElement("span");
              cardTag.className = "active-card-tag";
              cardTag.textContent = cardId;
              activeCardsListEl.appendChild(cardTag);
            });
            activeCardsCountEl.textContent = `(${cardIds.length})`;
          },
          (error) => {
            console.error("Error escuchando cartones activos:", error);
          }
        );
      }

      // NUEVO: Listener para solicitudes de BINGO (lo corren todos)
      function listenForBingoChecks() {
        if (!currentGameId) return;
        if (unsubscribeBingoChecks) unsubscribeBingoChecks();

        const cardsCollectionRef = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId,
          "cards"
        );

        unsubscribeBingoChecks = onSnapshot(
          cardsCollectionRef,
          (querySnapshot) => {
            querySnapshot.docChanges().forEach((change) => {
              const data = change.doc.data();
              const cardId = data.cardId;

              // Un admin detecta una solicitud pendiente
              if (
                data.bingoCheck === "pending" &&
                isAdmin &&
                !pendingBingoCheck &&
                !isGameWon
              ) {
                pendingBingoCheck = cardId;
                verifyBingo(cardId);
              }

              // El jugador que solicitó el check recibe la respuesta "denied"
              if (
                data.bingoCheck === "denied" &&
                localLoadedCards.has(cardId) &&
                change.type === "modified"
              ) {
                winMessageText.textContent = "¡Bingo Falso! Sigue jugando.";
                winMessage.classList.remove("bingo-win", "bg-transparent");
                winMessage.classList.add("bg-red-200", "text-red-800");
                winMessage.classList.remove("hidden");
                bingoButton.disabled = false; // Permitir volver a intentarlo

                // Limpiar el estado en la BD
                const cardDocRef = doc(
                  db,
                  "artifacts",
                  appId,
                  "public",
                  "data",
                  "bingo_games",
                  currentGameId,
                  "cards",
                  cardId
                );
                updateDoc(cardDocRef, { bingoCheck: null });
              }
            });
          },
          (error) => console.error("Error escuchando checks de bingo:", error)
        );
      }

      function resetLocalGame() {
        isGameWon = false;
        pendingBingoCheck = null;
        calledNumbers.clear();
        localLoadedCards.clear();
        cardsAreaElement.innerHTML = "";

        // Limpiar tablero
        ["B", "I", "N", "G", "O"].forEach((l) => {
          document.getElementById(`called-${l}`).innerHTML = "";
        });

        currentNumberDisplay.textContent = "-";
        winMessage.classList.add("hidden");
        winMessage.classList.remove(
          "bingo-win",
          "bg-red-200",
          "text-red-800",
          "bg-yellow-100",
          "text-yellow-700"
        );

        // Botones de jugador
        bingoButton.disabled = false;
        loadCardButton.disabled = false;
        syncCardsButton.disabled = false;

        if (isAdmin) {
          if (autoDrawInterval) stopAutoDraw();
          drawButton.disabled = false;
          autoDrawButton.disabled = false;
          activeCardsListEl.innerHTML = "";
          activeCardsCountEl.textContent = "(0)";
          prizeInput.value = "";
          gameModeSelect.value = "full_card";
          adminNotificationArea.classList.add("hidden");
          adminConfirmButtons.classList.add("hidden");
        }
        prizeDisplay.textContent = "¡Mucha Suerte!";
        gameModeDisplay.textContent = GAME_MODE_NAMES["full_card"];
      }

      // --- 5. Lógica de UI y Renderizado ---

      function updateCalledNumbersUI(drawnNumbers) {
        // Limpiar tableros
        ["B", "I", "N", "G", "O"].forEach((l) => {
          document.getElementById(`called-${l}`).innerHTML = "";
        });

        if (drawnNumbers.length === 0) {
          currentNumberDisplay.textContent = "-";
          return;
        }

        const lastNumber = drawnNumbers[drawnNumbers.length - 1];
        currentNumberDisplay.textContent = lastNumber;
        currentNumberDisplay.classList.add("pop");
        setTimeout(() => currentNumberDisplay.classList.remove("pop"), 200);

        // Poblar el tablero BINGO (ordenado normal, el CSS lo invierte)
        const sortedNumbers = [...drawnNumbers].sort((a, b) => a - b);
        sortedNumbers.forEach((number) => {
          const letter = getLetterForNumber(number);
          const numberEl = document.createElement("div");
          numberEl.className = "tote-board-number";
          numberEl.textContent = number;
          document.getElementById(`called-${letter}`).appendChild(numberEl);
        });
      }

      function handleCellClick(event) {
        if (isGameWon) return;

        const cell = event.currentTarget;
        const number = cell.dataset.number;

        if (number === "GRATIS") return;

        if (calledNumbers.has(parseInt(number, 10))) {
          cell.classList.toggle("marked");
        } else {
          cell.classList.add("shake");
          setTimeout(() => cell.classList.remove("shake"), 300);
        }
      }

      // --- 6. Lógica del Juego (Generar, Renderizar, Ganar) ---

      function getLetterForNumber(number) {
        if (number <= 15) return "B";
        if (number <= 30) return "I";
        if (number <= 45) return "N";
        if (number <= 60) return "G";
        if (number <= 75) return "O";
        return "";
      }

      function generateCardData() {
        let card = [];
        for (let c = 0; c < 5; c++) {
          let colNumbers = new Set();
          const { min, max } = BINGO_RANGES[c];
          const count = c === 2 ? 4 : 5;
          while (colNumbers.size < count) {
            const num = Math.floor(Math.random() * (max - min + 1)) + min;
            colNumbers.add(num);
          }
          let colArray = Array.from(colNumbers);
          if (c === 2) {
            colArray.splice(2, 0, "GRATIS");
          }
          card.push(colArray);
        }
        return card;
      }

      function renderCard(cardData, cardIndex, cardId) {
        const cardWrapper = document.createElement("div");
        cardWrapper.id = `card-${cardIndex}`;
        cardWrapper.dataset.cardId = cardId;
        cardWrapper.className = "bg-white p-4 rounded-lg shadow-inner";

        const title = document.createElement("h3");
        title.className = "text-xl font-bold text-center text-purple-600 mb-3";
        title.textContent = `Cartón #${cardId}`;
        cardWrapper.appendChild(title);

        const grid = document.createElement("div");
        grid.className = "bingo-card-grid";

        for (let r = 0; r < 5; r++) {
          for (let c = 0; c < 5; c++) {
            const number = cardData[c][r];
            const cell = document.createElement("div");
            cell.classList.add("bingo-cell");
            cell.textContent = number;
            cell.dataset.col = c;
            cell.dataset.row = r;
            cell.dataset.number = number;
            cell.dataset.cardIndex = cardIndex;

            if (number === "GRATIS") {
              cell.classList.add("free", "marked");
            } else {
              cell.addEventListener("click", handleCellClick);
            }

            grid.appendChild(cell);
          }
        }
        cardWrapper.appendChild(grid);
        cardsAreaElement.appendChild(cardWrapper);
      }

      // --- LÓGICA DE VICTORIA (VALIDACIÓN DEL ADMIN) ---

      // NUEVO: El admin pausa y verifica
      async function verifyBingo(cardId) {
        if (autoDrawInterval) stopAutoDraw();
        drawButton.disabled = true;
        adminNotificationArea.textContent = `Cartón #${cardId} canta ¡BINGO! Verificando...`;
        adminNotificationArea.className =
          "text-center p-3 rounded-lg bg-yellow-200 text-yellow-800 font-semibold";
        adminNotificationArea.classList.remove("hidden");

        // Cargar datos del cartón
        const cardDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId,
          "cards",
          cardId
        );
        const cardDoc = await getDoc(cardDocRef);
        if (!cardDoc.exists()) {
          adminNotificationArea.textContent = `Error: Cartón #${cardId} no encontrado.`;
          handleRejectWin(); // Rechazar si no se encuentra
          return;
        }

        const cardData = JSON.parse(cardDoc.data().cardData);

        // Validación 100% segura en el lado del admin
        const isWinner = checkWinAdmin(
          cardData,
          calledNumbers,
          currentGameMode
        );

        if (isWinner) {
          adminNotificationArea.textContent = `¡BINGO CONFIRMADO! Cartón #${cardId}. Esperando decisión...`;
          adminNotificationArea.className =
            "text-center p-3 rounded-lg bg-green-200 text-green-800 font-semibold";
          adminConfirmButtons.classList.remove("hidden");
        } else {
          adminNotificationArea.textContent = `¡BINGO FALSO! Cartón #${cardId} no ha ganado. Continuando...`;
          adminNotificationArea.className =
            "text-center p-3 rounded-lg bg-red-200 text-red-800 font-semibold";
          setTimeout(() => adminNotificationArea.classList.add("hidden"), 3000);
          handleRejectWin(); // Rechazar si no es ganador
        }
      }

      // NUEVO: Botón de admin para confirmar
      async function handleConfirmWin() {
        if (!pendingBingoCheck || !currentGameId) return;
        const gameDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId
        );
        await updateDoc(gameDocRef, {
          gameStatus: "finished",
          winnerCardId: pendingBingoCheck,
        });
        // El listener `listenToGameData` se encargará de parar todo
        adminConfirmButtons.classList.add("hidden");
        adminNotificationArea.classList.add("hidden");
        pendingBingoCheck = null;
      }

      // NUEVO: Botón de admin para rechazar
      async function handleRejectWin() {
        if (!pendingBingoCheck || !currentGameId) return;
        const cardDocRef = doc(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "bingo_games",
          currentGameId,
          "cards",
          pendingBingoCheck
        );
        await updateDoc(cardDocRef, { bingoCheck: "denied" });

        adminNotificationArea.classList.add("hidden");
        adminConfirmButtons.classList.add("hidden");

        pendingBingoCheck = null;

        // Reanudar sorteo
        drawButton.disabled = false;
        // No reiniciar auto-draw, dejar que el admin lo haga
      }

      // NUEVO: Lógica de checkeo 100% segura (corre en el admin)
      function checkWinAdmin(cardData, drawnNumbers, mode) {
        // cardData es [col][row]
        const isMarked = (c, r) => {
          const num = cardData[c][r];
          return num === "GRATIS" || drawnNumbers.has(num);
        };

        switch (mode) {
          case "full_card":
            for (let c = 0; c < 5; c++) {
              for (let r = 0; r < 5; r++) {
                if (!isMarked(c, r)) return false;
              }
            }
            return true;

          case "h_line":
            for (let r = 0; r < 5; r++) {
              if ([...Array(5).keys()].every((c) => isMarked(c, r))) {
                return true;
              }
            }
            return false;

          case "v_line":
            for (let c = 0; c < 5; c++) {
              if ([...Array(5).keys()].every((r) => isMarked(c, r))) {
                return true;
              }
            }
            return false;

          case "corners":
            return (
              isMarked(0, 0) &&
              isMarked(4, 0) &&
              isMarked(0, 4) &&
              isMarked(4, 4)
            );

          default:
            return false;
        }
      }
    </script>
  </body>
</html>
